{% extends "base.html" %}

{% block content %}
  {% include "components/admin_nav.html" %}

  {# --- Defaults / safe fallbacks so the preview is always complete --- #}
  {% set company_name = "Dynastra Tech" %}
  {% set company_email = "info@dynastra.co.uk" %}
  {% set company_site  = "dynastra.co.uk" %}
  {% set company_phone = "+44 7911 123456" %} {# TODO: replace with your real number #}

  {% if invoice %}
    {% set account_name   = invoice.accountName or "Dynastra Tech" %}
    {% set sort_code      = invoice.sortCode or "12-34-56" %}
    {% set account_number = invoice.accountNumber or "12345678" %}
    {% set iban           = invoice.iban or "GB00 DYN0 1234 5678 9012 34" %}
  {% else %}
    {# When previewing from form data without a stored invoice yet #}
    {% set account_name   = "Dynastra Tech" %}
    {% set sort_code      = "12-34-56" %}
    {% set account_number = "12345678" %}
    {% set iban           = "GB00 DYN0 1234 5678 9012 34" %}
  {% endif %}

  <!-- Screen-only action bar -->
  <div class="previewA-actions no-printA">
    {% if invoice %}
      <a href="/admin/invoice/save/{{ invoice.id }}" class="btnA primaryA">Save</a>
      <a href="/admin/invoice/send/{{ invoice.id }}" class="btnA successA">Send</a>
    {% else %}
      <form method="post" action="/admin/invoice/save">
        <!-- include hidden fields here if your save route expects them -->
        <button type="submit" class="btnA primaryA">Save</button>
      </form>
    {% endif %}
    <button onclick="window.print()" class="btnA">Print</button>
  </div>

  <!-- A4 preview -->
  <div class="printA-wrap">
    <div class="sheetA">
      <div class="sheetA-body">

        <!-- Header -->
        <div class="invA-header">
          <div class="invA-brand">
            <img src="/static/logos/dynastra_dark.png" alt="Logo" class="invA-logo" />
            <div>
              <h1 class="invA-title">Invoice</h1>
              <div style="font-size:12px; color:#6b7280;">
                {{ company_name }} • {{ company_site }}
              </div>
            </div>
          </div>
          <div class="invA-meta">
            <div><strong>Date:</strong>
              {% if invoice %}{{ invoice.invoiceDate.strftime('%d/%m/%Y') }}
              {% else %}{{ issue_date or '—' }}{% endif %}
            </div>
            <div><strong>Due:</strong>
              {% if invoice %}{{ invoice.dueDate.strftime('%d/%m/%Y') }}
              {% else %}{{ due_date or '—' }}{% endif %}
            </div>
            <div><strong>Total:</strong>
              £{% if invoice %}{{ '%.2f' % invoice.total }}{% else %}{{ '%.2f' % total }}{% endif %}
            </div>
          </div>
        </div>

        <!-- Parties -->
        <div class="invA-block">
          <div>
            <p class="invA-subtitle">Bill To</p>
            <div class="invA-strong">
              {% if invoice %}
                {{ invoice.client.name }} {{ invoice.client.surname }}
              {% else %}
                {% if client %}{{ client.name }} {{ client.surname }}{% else %}—{% endif %}
              {% endif %}
            </div>
            <div>
              {% if invoice %}{{ invoice.client.email }}
              {% else %}{% if client %}{{ client.email }}{% else %}—{% endif %}{% endif %}
            </div>
            <div>
              {% if invoice %}{{ invoice.client.phone }}
              {% else %}{% if client %}{{ client.phone }}{% else %}—{% endif %}{% endif %}
            </div>
            <div style="margin-top:4px;">
              {% if invoice %}{{ invoice.client.address or '—' }}
              {% else %}{% if client %}{{ client.address or '—' }}{% else %}—{% endif %}{% endif %}
            </div>
          </div>

          <div>
            <p class="invA-subtitle">From</p>
            <div class="invA-strong">{{ company_name }}</div>
            <div>{{ company_email }}</div>
            <div>{{ company_phone }} • {{ company_site }}</div>
            <div style="margin-top:8px;"><strong>Account Name:</strong> {{ account_name }}</div>
            <div><strong>Sort Code:</strong> {{ sort_code }}</div>
            <div><strong>Account Number:</strong> {{ account_number }}</div>
            <div><strong>IBAN:</strong> {{ iban }}</div>
          </div>
        </div>

        <!-- Services -->
        <div class="sectionA">
          <table class="invA-table">
            <thead>
              <tr>
                <th>Description</th>
                <th class="trightA">Price (£)</th>
              </tr>
            </thead>
            <tbody>
              {% if invoice %}
                {% for s in invoice.services %}
                  <tr>
                    <td>{{ s.description }}</td>
                    <td class="trightA">£{{ '%.2f' % s.price }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                {% for s in services %}
                  <tr>
                    <td>{{ s.description }}</td>
                    <td class="trightA">£{{ '%.2f' % s.price }}</td>
                  </tr>
                {% endfor %}
              {% endif %}
              <tr class="invA-totalRow">
                <td class="trightA"><strong>Total:</strong></td>
                <td class="trightA"><strong>
                  £{% if invoice %}{{ '%.2f' % invoice.total }}{% else %}{{ '%.2f' % total }}{% endif %}
                </strong></td>
              </tr>
            </tbody>
          </table>
        </div>

        {% if notes %}
          <div class="sectionA" style="margin-top:10mm;">
            <div class="invA-subtitle">Notes</div>
            <div style="font-size:12px; color:#374151;">{{ notes }}</div>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
{% endblock %}
