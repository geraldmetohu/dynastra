{% extends "base.html" %}

{% block content %}
  {% include "components/admin_nav.html" %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/admin.css') }}">

</head>
  <div class="bg-gray-100A text-gray-800A p-8A min-h-screenA">
    <div class="max-w-5xlA mx-auto bg-whiteA rounded-xlA shadow-mdA p-6A">
      <h2 class="text-2xlA mb-6A">Create New Invoice</h2>

      <form method="POST" action="/admin/invoice/preview" id="invoice-form" class="space-y-6A">
        <!-- Client Selection -->
        <div>
          <label for="client_id" class="blockA mb-1A">Select Client</label>
          <select id="client_id" name="client_id" required class="w-fullA p-2A borderA border-gray-300A rounded-mdA">
            <option value="">-- Select Client --</option>
            {% for client in clients %}
              <option
                value="{{ client.id }}"
                data-name="{{ client.name|e }} {{ client.surname|e }}"
                data-email="{{ client.email|e }}"
                data-phone="{{ client.phone|e }}"
                data-address="{{ client.address or '' | e }}"
              >
                {{ client.name }} {{ client.surname }} — {{ client.email }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Auto-filled Client Info -->
        <div class="gridA grid-cols-2A gap-4A">
          <div>
            <label class="blockA mb-1A">Name</label>
            <input type="text" id="client_name" readonly class="w-fullA p-2A borderA border-gray-300A rounded-mdA bg-whiteA">
          </div>
          <div>
            <label class="blockA mb-1A">Email</label>
            <input type="text" id="client_email" readonly class="w-fullA p-2A borderA border-gray-300A rounded-mdA bg-whiteA">
          </div>
          <div>
            <label class="blockA mb-1A">Phone</label>
            <input type="text" id="client_phone" readonly class="w-fullA p-2A borderA border-gray-300A rounded-mdA bg-whiteA">
          </div>
          <div>
            <label class="blockA mb-1A">Address</label>
            <input type="text" id="client_address" readonly class="w-fullA p-2A borderA border-gray-300A rounded-mdA bg-whiteA">
          </div>
        </div>

        <!-- Invoice Meta -->
        <div class="gridA grid-cols-2A gap-4A">
          <div>
            <label for="issue_date" class="blockA mb-1A">Issue Date</label>
            <input type="date" id="issue_date" name="issue_date" required class="w-fullA p-2A borderA border-gray-300A rounded-mdA">
          </div>
          <div>
            <label for="due_date" class="blockA mb-1A">Due Date</label>
            <input type="date" id="due_date" name="due_date" required class="w-fullA p-2A borderA border-gray-300A rounded-mdA">
          </div>
        </div>

        <!-- Services (dynamic) -->
        <div>
          <label class="blockA mb-2A">Services</label>

          <div id="services-container" class="space-y-3A">
            <!-- rows injected by JS -->
          </div>

          <div class="mt-2A">
            <button type="button" id="add-service" class="btnA">+ Add Service</button>
          </div>
        </div>

        <!-- Notes -->
        <div>
          <label for="notes" class="blockA mb-1A">Additional Notes</label>
          <textarea id="notes" name="notes" rows="4" class="w-fullA p-2A borderA border-gray-300A rounded-mdA"></textarea>
        </div>

        <!-- Submit -->
        <div class="text-rightA">
          <button type="submit" class="btnA">Preview Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    /* small tweaks for this page */
    .service-rowA { display:flex; gap:12px; align-items:center; }
    .service-rowA .descA { flex: 1; }
    .service-rowA .priceA { width: 140px; }
    .removeA { background:#ef4444; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .removeA:hover { background:#dc2626; }
    @media (max-width: 640px) {
      .service-rowA { flex-direction: column; align-items: stretch; }
      .service-rowA .priceA { width: 100%; }
    }
  </style>

  <script>
    // Autofill client info from option data- attributes
    const selectEl = document.getElementById('client_id');
    selectEl.addEventListener('change', () => {
      const opt = selectEl.options[selectEl.selectedIndex];
      if (!opt || !opt.dataset) return;
      document.getElementById('client_name').value   = opt.dataset.name   || '';
      document.getElementById('client_email').value  = opt.dataset.email  || '';
      document.getElementById('client_phone').value  = opt.dataset.phone  || '';
      document.getElementById('client_address').value= opt.dataset.address|| '';
    });

    // Services dynamic rows
    const container = document.getElementById('services-container');
    const addBtn = document.getElementById('add-service');

    function addServiceRow() {
      const row = document.createElement('div');
      row.className = 'service-rowA';

      row.innerHTML = `
        <input type="text" name="service_description" placeholder="Description"
               class="descA p-2A borderA border-gray-300A rounded-mdA" required>
        <input type="number" name="service_price" placeholder="Price"
               class="priceA p-2A borderA border-gray-300A rounded-mdA" step="0.01" min="0" required>
        <button type="button" class="removeA" title="Remove">✕</button>
      `;

      row.querySelector('.removeA').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }

    addBtn.addEventListener('click', addServiceRow);

    // Ensure at least one row initially
    addServiceRow();
  </script>
  <script>
  const pre = "{{ preselect_client_id or '' }}";
  if (pre) {
    const sel = document.getElementById('client_id');
    sel.value = pre;
    sel.dispatchEvent(new Event('change'));
  }
</script>

{% endblock %}
